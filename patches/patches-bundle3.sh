#!/bin/sh
# MC-Playum Patch Bundle
# Generated: 2025-12-23 19:32:31
# Patches: 20 to 20

set -e

BUNDLE_MIN=20
BUNDLE_MAX=20
EXTRACT_DIR="/tmp/patches"

show_list() {
    echo "Patches in this bundle:"
    printf "%s\n" "  20: wifi-ui-support\n"
}

show_status() {
    PATCH_LEVEL_FILE="/mnt/dietpi_userdata/innovo/config/patch-level"
    if [ -f "$PATCH_LEVEL_FILE" ]; then
        CURRENT=$(cat "$PATCH_LEVEL_FILE")
        echo "Current patch level: $CURRENT"
        if [ "$CURRENT" -ge "$BUNDLE_MAX" ]; then
            echo "Status: All patches already applied"
        else
            echo "Status: Will apply patches $((CURRENT + 1)) to $BUNDLE_MAX"
        fi
    else
        echo "Current patch level: 0 (not initialized)"
        echo "Status: Fresh device, will apply all patches"
    fi
}

case "$1" in
    --list) show_list; exit 0 ;;
    --status) show_status; exit 0 ;;
esac

rm -rf "$EXTRACT_DIR"
mkdir -p "$EXTRACT_DIR"
echo "Extracting patches..."

# Decode and extract payload
echo "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" | base64 -d | tar xzf - -C "$EXTRACT_DIR"

echo "Running patches..."
bash "$EXTRACT_DIR/apply-patches.sh" "$@"
PATCH_EXIT_CODE=$?

# Refresh manifest from GitHub and trigger UI update if available
echo ""
echo "Updating MCDealerCloud configuration..."
MANIFEST_URL="https://raw.githubusercontent.com/InnovoDeveloper/innovo-version-tracker/main/magiccube.json"
MANIFEST_FILE="/mnt/dietpi_userdata/innovo/config/versions/manifest.json"
mkdir -p "$(dirname "$MANIFEST_FILE")"
if curl -4 -sf --connect-timeout 10 --max-time 30 "$MANIFEST_URL" -o "$MANIFEST_FILE" 2>/dev/null; then
    echo "MCDealerCloud updated successfully (from GitHub)"
else
    echo "Network unavailable - using embedded manifest fallback"
    echo "ewogICJtZXRhZGF0YSI6IHsKICAgICJkZXNjcmlwdGlvbiI6ICJJbm5vdm8gU29mdHdhcmUgVmVyc2lvbiBUcmFja2luZyIsCiAgICAibGFzdF91cGRhdGVkIjogIjIwMjUtMTItMTlUMDE6NDA6MDBaIgogIH0sCiAgImRldmljZXMiOiB7CiAgICAibWNwbGF5dW0iOiB7CiAgICAgICJtb2RlbCI6ICJNQ1BsYXl1bSIsCiAgICAgICJwYWNrYWdlcyI6IFsKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAic3F1ZWV6ZWxpdGUiLAogICAgICAgICAgIm5hbWUiOiAiU3F1ZWV6ZWxpdGUiLAogICAgICAgICAgInJlcG8iOiAicmFscGgtaXJ2aW5nL3NxdWVlemVsaXRlIiwKICAgICAgICAgICJjdXJyZW50X3ZlcnNpb24iOiAiMi4wLjAtMTU0MSIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICIyLjAuMC0xNTQxIiwKICAgICAgICAgICJkaWV0cGlfaWQiOiAzNiwKICAgICAgICAgICJkb3dubG9hZF91cmwiOiBudWxsLAogICAgICAgICAgInJlcXVpcmVzX3JlYm9vdCI6IGZhbHNlLAogICAgICAgICAgInVwZGF0ZV9tZXRob2QiOiAiZGlldHBpIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgImlkIjogInJhc3BvdGlmeSIsCiAgICAgICAgICAibmFtZSI6ICJSYXNwb3RpZnkiLAogICAgICAgICAgInJlcG8iOiAiZHRjb29wZXIvcmFzcG90aWZ5IiwKICAgICAgICAgICJjdXJyZW50X3ZlcnNpb24iOiAiMC40OC4xIiwKICAgICAgICAgICJhcHByb3ZlZF92ZXJzaW9uIjogIjAuNDguMSIsCiAgICAgICAgICAiZGlldHBpX2lkIjogMTY3LAogICAgICAgICAgImRvd25sb2FkX3VybCI6IG51bGwsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogZmFsc2UsCiAgICAgICAgICAidXBkYXRlX21ldGhvZCI6ICJkaWV0cGkiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAic2hhaXJwb3J0LXN5bmMiLAogICAgICAgICAgIm5hbWUiOiAiU2hhaXJwb3J0LVN5bmMiLAogICAgICAgICAgInJlcG8iOiAibWlrZWJyYWR5L3NoYWlycG9ydC1zeW5jIiwKICAgICAgICAgICJjdXJyZW50X3ZlcnNpb24iOiAiNC4zLjciLAogICAgICAgICAgImFwcHJvdmVkX3ZlcnNpb24iOiAiNC4zLjciLAogICAgICAgICAgImRpZXRwaV9pZCI6IDM3LAogICAgICAgICAgImRvd25sb2FkX3VybCI6IG51bGwsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogZmFsc2UsCiAgICAgICAgICAidXBkYXRlX21ldGhvZCI6ICJkaWV0cGkiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAiZGlldHBpIiwKICAgICAgICAgICJuYW1lIjogIkRpZXRQaSIsCiAgICAgICAgICAicmVwbyI6ICJNaWNoYUluZy9EaWV0UGkiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICI5LjIwLjEiLAogICAgICAgICAgImFwcHJvdmVkX3ZlcnNpb24iOiAiOS4yMC4xIiwKICAgICAgICAgICJkaWV0cGlfaWQiOiBudWxsLAogICAgICAgICAgImRvd25sb2FkX3VybCI6IG51bGwsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogdHJ1ZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRpZXRwaS11cGRhdGUiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAibWMtdWkiLAogICAgICAgICAgIm5hbWUiOiAiTUMtVUkiLAogICAgICAgICAgInJlcG8iOiBudWxsLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICIxLjAuMCIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICIxLjAuMCIsCiAgICAgICAgICAiZGlldHBpX2lkIjogbnVsbCwKICAgICAgICAgICJkb3dubG9hZF91cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL0lubm92b0RldmVsb3Blci9tYy1wbGF5dW0vcmVsZWFzZXMvZG93bmxvYWQvdjEuMC4wL21jLXVpLnRhci5neiIsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogZmFsc2UsCiAgICAgICAgICAidXBkYXRlX21ldGhvZCI6ICJkb3dubG9hZCIKICAgICAgICB9CiAgICAgIF0KICAgIH0sCgogICAgIm1hZ2ljY3ViZWF1cmEiOiB7CiAgICAgICJtb2RlbCI6ICJNYWdpY0N1YmVBdXJhIiwKICAgICAgInBhY2thZ2VzIjogWwogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJzcXVlZXplbGl0ZSIsCiAgICAgICAgICAibmFtZSI6ICJTcXVlZXplbGl0ZSIsCiAgICAgICAgICAicmVwbyI6ICJyYWxwaC1pcnZpbmcvc3F1ZWV6ZWxpdGUiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICIyLjAuMC0xNTQxIiwKICAgICAgICAgICJhcHByb3ZlZF92ZXJzaW9uIjogIjIuMC4wLTE1NDEiLAogICAgICAgICAgImRpZXRwaV9pZCI6IDM2LAogICAgICAgICAgImRvd25sb2FkX3VybCI6IG51bGwsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogZmFsc2UsCiAgICAgICAgICAidXBkYXRlX21ldGhvZCI6ICJkaWV0cGkiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAicmFzcG90aWZ5IiwKICAgICAgICAgICJuYW1lIjogIlJhc3BvdGlmeSIsCiAgICAgICAgICAicmVwbyI6ICJkdGNvb3Blci9yYXNwb3RpZnkiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICIwLjQ4LjEiLAogICAgICAgICAgImFwcHJvdmVkX3ZlcnNpb24iOiAiMC40OC4xIiwKICAgICAgICAgICJkaWV0cGlfaWQiOiAxNjcsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogbnVsbCwKICAgICAgICAgICJyZXF1aXJlc19yZWJvb3QiOiBmYWxzZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRpZXRwaSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJzaGFpcnBvcnQtc3luYyIsCiAgICAgICAgICAibmFtZSI6ICJTaGFpcnBvcnQtU3luYyIsCiAgICAgICAgICAicmVwbyI6ICJtaWtlYnJhZHkvc2hhaXJwb3J0LXN5bmMiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICI0LjMuNyIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICI0LjMuNyIsCiAgICAgICAgICAiZGlldHBpX2lkIjogMzcsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogbnVsbCwKICAgICAgICAgICJyZXF1aXJlc19yZWJvb3QiOiBmYWxzZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRpZXRwaSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJsbXMiLAogICAgICAgICAgIm5hbWUiOiAiTHlyaW9uIE11c2ljIFNlcnZlciIsCiAgICAgICAgICAicmVwbyI6ICJMTVMtQ29tbXVuaXR5L3NsaW1zZXJ2ZXIiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICI5LjEuMH4xNzY1NjkzMTI3IiwKICAgICAgICAgICJhcHByb3ZlZF92ZXJzaW9uIjogIjkuMS4wfjE3NjU2OTMxMjciLAogICAgICAgICAgImRpZXRwaV9pZCI6IG51bGwsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9Jbm5vdm9EZXZlbG9wZXIvaW5ub3ZvLXZlcnNpb24tdHJhY2tlci9yZWxlYXNlcy9kb3dubG9hZC9sbXMtOS4xLjAvbHlyaW9ubXVzaWNzZXJ2ZXJfOS4xLjAuMTc2NTY5MzEyN19hbGwuZGViIiwKICAgICAgICAgICJyZXF1aXJlc19yZWJvb3QiOiBmYWxzZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRwa2ciCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAiZGlldHBpIiwKICAgICAgICAgICJuYW1lIjogIkRpZXRQaSIsCiAgICAgICAgICAicmVwbyI6ICJNaWNoYUluZy9EaWV0UGkiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICI5LjIwLjEiLAogICAgICAgICAgImFwcHJvdmVkX3ZlcnNpb24iOiAiOS4yMC4xIiwKICAgICAgICAgICJkaWV0cGlfaWQiOiBudWxsLAogICAgICAgICAgImRvd25sb2FkX3VybCI6IG51bGwsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogdHJ1ZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRpZXRwaS11cGRhdGUiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAiaG9tZWFzc2lzdGFudCIsCiAgICAgICAgICAibmFtZSI6ICJIb21lIEFzc2lzdGFudCBDb3JlIiwKICAgICAgICAgICJyZXBvIjogImhvbWUtYXNzaXN0YW50L2NvcmUiLAogICAgICAgICAgImN1cnJlbnRfdmVyc2lvbiI6ICIyMDI1LjQuNCIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICIyMDI1LjQuNCIsCiAgICAgICAgICAiZGlldHBpX2lkIjogbnVsbCwKICAgICAgICAgICJkb3dubG9hZF91cmwiOiBudWxsLAogICAgICAgICAgInJlcXVpcmVzX3JlYm9vdCI6IHRydWUsCiAgICAgICAgICAidXBkYXRlX21ldGhvZCI6ICJoYS11cGdyYWRlIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgImlkIjogImF1cmEtdWkiLAogICAgICAgICAgIm5hbWUiOiAiQXVyYSBVSSIsCiAgICAgICAgICAicmVwbyI6IG51bGwsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjEuMC4xMiIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICIxLjAuMTIiLAogICAgICAgICAgImRpZXRwaV9pZCI6IG51bGwsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9Jbm5vdm9EZXZlbG9wZXIvaW5ub3ZvLXZlcnNpb24tdHJhY2tlci9tYWluL3JlbGVhc2VzL2F1cmEvYXVyYS11aS0xLjAuMTIudGFyLmd6IiwKICAgICAgICAgICJyZXF1aXJlc19yZWJvb3QiOiBmYWxzZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRvd25sb2FkIgogICAgICAgIH0KICAgICAgXQogICAgfSwKCiAgICAibWNkaiI6IHsKICAgICAgIm1vZGVsIjogIk1DREoiLAogICAgICAicGFja2FnZXMiOiBbCiAgICAgICAgewogICAgICAgICAgImlkIjogInNxdWVlemVsaXRlIiwKICAgICAgICAgICJuYW1lIjogIlNxdWVlemVsaXRlIiwKICAgICAgICAgICJyZXBvIjogInJhbHBoLWlydmluZy9zcXVlZXplbGl0ZSIsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjIuMC4wLTE1NDEiLAogICAgICAgICAgImFwcHJvdmVkX3ZlcnNpb24iOiAiMi4wLjAtMTU0MSIsCiAgICAgICAgICAiZGlldHBpX2lkIjogMzYsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogbnVsbCwKICAgICAgICAgICJyZXF1aXJlc19yZWJvb3QiOiBmYWxzZSwKICAgICAgICAgICJ1cGRhdGVfbWV0aG9kIjogImRpZXRwaSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJyYXNwb3RpZnkiLAogICAgICAgICAgIm5hbWUiOiAiUmFzcG90aWZ5IiwKICAgICAgICAgICJyZXBvIjogImR0Y29vcGVyL3Jhc3BvdGlmeSIsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjAuNDguMSIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICIwLjQ4LjEiLAogICAgICAgICAgImRpZXRwaV9pZCI6IDE2NywKICAgICAgICAgICJkb3dubG9hZF91cmwiOiBudWxsLAogICAgICAgICAgInJlcXVpcmVzX3JlYm9vdCI6IGZhbHNlLAogICAgICAgICAgInVwZGF0ZV9tZXRob2QiOiAiZGlldHBpIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgImlkIjogInNoYWlycG9ydC1zeW5jIiwKICAgICAgICAgICJuYW1lIjogIlNoYWlycG9ydC1TeW5jIiwKICAgICAgICAgICJyZXBvIjogIm1pa2VicmFkeS9zaGFpcnBvcnQtc3luYyIsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjQuMy43IiwKICAgICAgICAgICJhcHByb3ZlZF92ZXJzaW9uIjogIjQuMy43IiwKICAgICAgICAgICJkaWV0cGlfaWQiOiAzNywKICAgICAgICAgICJkb3dubG9hZF91cmwiOiBudWxsLAogICAgICAgICAgInJlcXVpcmVzX3JlYm9vdCI6IGZhbHNlLAogICAgICAgICAgInVwZGF0ZV9tZXRob2QiOiAiZGlldHBpIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgImlkIjogImxtcyIsCiAgICAgICAgICAibmFtZSI6ICJMeXJpb24gTXVzaWMgU2VydmVyIiwKICAgICAgICAgICJyZXBvIjogIkxNUy1Db21tdW5pdHkvc2xpbXNlcnZlciIsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjkuMS4wfjE3NjU2OTMxMjciLAogICAgICAgICAgImFwcHJvdmVkX3ZlcnNpb24iOiAiOS4xLjB+MTc2NTY5MzEyNyIsCiAgICAgICAgICAiZGlldHBpX2lkIjogbnVsbCwKICAgICAgICAgICJkb3dubG9hZF91cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL0lubm92b0RldmVsb3Blci9pbm5vdm8tdmVyc2lvbi10cmFja2VyL3JlbGVhc2VzL2Rvd25sb2FkL2xtcy05LjEuMC9seXJpb25tdXNpY3NlcnZlcl85LjEuMC4xNzY1NjkzMTI3X2FsbC5kZWIiLAogICAgICAgICAgInJlcXVpcmVzX3JlYm9vdCI6IGZhbHNlLAogICAgICAgICAgInVwZGF0ZV9tZXRob2QiOiAiZHBrZyIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJkaWV0cGkiLAogICAgICAgICAgIm5hbWUiOiAiRGlldFBpIiwKICAgICAgICAgICJyZXBvIjogIk1pY2hhSW5nL0RpZXRQaSIsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjkuMjAuMSIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICI5LjIwLjEiLAogICAgICAgICAgImRpZXRwaV9pZCI6IG51bGwsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogbnVsbCwKICAgICAgICAgICJyZXF1aXJlc19yZWJvb3QiOiB0cnVlLAogICAgICAgICAgInVwZGF0ZV9tZXRob2QiOiAiZGlldHBpLXVwZGF0ZSIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJtYy11aSIsCiAgICAgICAgICAibmFtZSI6ICJNQy1ESiBVSSIsCiAgICAgICAgICAicmVwbyI6IG51bGwsCiAgICAgICAgICAiY3VycmVudF92ZXJzaW9uIjogIjEuMC4xMSIsCiAgICAgICAgICAiYXBwcm92ZWRfdmVyc2lvbiI6ICIxLjAuMTEiLAogICAgICAgICAgImRpZXRwaV9pZCI6IG51bGwsCiAgICAgICAgICAiZG93bmxvYWRfdXJsIjogImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9Jbm5vdm9EZXZlbG9wZXIvaW5ub3ZvLXZlcnNpb24tdHJhY2tlci9tYWluL3JlbGVhc2VzL21jZGovbWMtdWktMS4wLjExLnRhci5neiIsCiAgICAgICAgICAicmVxdWlyZXNfcmVib290IjogZmFsc2UsCiAgICAgICAgICAidXBkYXRlX21ldGhvZCI6ICJkb3dubG9hZCIKICAgICAgICB9CiAgICAgIF0KICAgIH0KICB9Cn0K" | base64 -d > "$MANIFEST_FILE"
fi
chown www-data:www-data "$MANIFEST_FILE" 2>/dev/null || true
chmod 0664 "$MANIFEST_FILE" 2>/dev/null || true

# Check for UI update
echo ""
echo "Checking for UI updates..."
UI_UPDATE_SCRIPT="/mnt/dietpi_userdata/innovo/app/backend/cgi-scripts/update_mc_ui.sh"
if [ -x "$UI_UPDATE_SCRIPT" ]; then
    # Get current version from version.json using jq (preferred) or grep fallback
    VERSION_JSON="/mnt/dietpi_userdata/innovo/app/frontend/html/version.json"
    if [ -f "$VERSION_JSON" ]; then
        if command -v jq >/dev/null 2>&1; then
            CURRENT_UI_VERSION=$(jq -r ".version // empty" "$VERSION_JSON" 2>/dev/null)
        else
            CURRENT_UI_VERSION=$(grep -o '"version"[^,}]*' "$VERSION_JSON" 2>/dev/null | sed 's/.*: *"//;s/".*//' || echo "")
        fi
    fi
    CURRENT_UI_VERSION="${CURRENT_UI_VERSION:-unknown}"
    
    # Get available version from manifest
    AVAILABLE_UI_VERSION=""
    if [ -f "$MANIFEST_FILE" ] && command -v jq >/dev/null 2>&1; then
        AVAILABLE_UI_VERSION=$(jq -r ".devices.mcdj.packages[] | select(.id==\"mc-ui\") | .approved_version // empty" "$MANIFEST_FILE" 2>/dev/null | head -1)
    fi
    
    echo "  Current UI: $CURRENT_UI_VERSION"
    echo "  Available: ${AVAILABLE_UI_VERSION:-not found in manifest}"
    
    # Check if update needed
    if [ -n "$AVAILABLE_UI_VERSION" ] && [ "$AVAILABLE_UI_VERSION" != "null" ] && [ "$CURRENT_UI_VERSION" != "$AVAILABLE_UI_VERSION" ]; then
        echo "UI update available: $CURRENT_UI_VERSION -> $AVAILABLE_UI_VERSION"
        echo "Running UI update..."
        "$UI_UPDATE_SCRIPT"
    elif [ -z "$AVAILABLE_UI_VERSION" ] || [ "$AVAILABLE_UI_VERSION" = "null" ]; then
        echo "Could not determine available version from manifest"
    else
        echo "UI is up to date"
    fi
else
    echo "UI update script not found, skipping"
fi

echo ""
echo "Done!"

echo "Cleaning up..."
rm -rf "$EXTRACT_DIR"

exit $PATCH_EXIT_CODE
